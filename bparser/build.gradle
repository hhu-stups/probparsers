apply plugin: 'jacoco'
apply plugin: 'java'
apply plugin: 'de.hhu.stups.sablecc'

dependencies {
    sableCC(rootProject.sableCCDependency)
    compile project(":prologlib")
    compile project(":parserbase")
}

def readCurrentGitCommit() {
    def proc = ["git", "rev-parse", "HEAD"].execute(null, project.projectDir)
    def exitCode = proc.waitFor()
    if (exitCode != 0) {
        throw new IllegalStateException("git rev-parse command exited with status code ${exitCode}:\n" + proc.err.readLines().join("\n"))
    }
    return proc.in.readLines()[0]
}

final BUILD_PROPERTIES = file("src/main/resources/bparser-build.properties")

task createBuildConstants {
    doFirst {
        BUILD_PROPERTIES.parentFile.mkdirs()
        BUILD_PROPERTIES.delete()
        BUILD_PROPERTIES << "version=${project.version}\n"
        BUILD_PROPERTIES << "git=${readCurrentGitCommit()}\n"
    }
}
processResources.dependsOn(createBuildConstants)

task cleanBuildConstants(type: Delete) {
    delete(BUILD_PROPERTIES)
}
clean.dependsOn(cleanBuildConstants)

rootProject.setupTestReport(project, ["de.be4.classicalb.core.parser", "de.be4.classicalb.core.preparser"])
